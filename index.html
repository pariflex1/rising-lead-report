<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leads - The Rising</title>
  <meta name="description" content="The Rising Facebook Ads Leads" />
  <meta property="og:title" content="Details of Facebook Ads Leads" />
  <meta property="og:description" content="Facebook Ads Leads" />
  <meta property="og:image" content="https://github.com/pariflex1/rising-lead-report/blob/main/og.webp?raw=true" />
   <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');

        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #FFC107; /* Amber */
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --text-color: #333;
            --header-bg: #2196F3; /* Blue */
            --header-text: #ffffff;
            --border-color: #e0e0e0;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 20px 0;
            text-align: center;
            box-shadow: var(--shadow);
        }

        header h1 {
            margin: 0;
            font-size: 2em;
        }

        .date-picker-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px; /* Added margin-top for separation */
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .date-picker-container label {
            margin-right: 10px;
            font-weight: bold;
        }

        .date-picker-container input[type="text"] {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
            width: 180px;
            text-align: center;
        }

        .table-container {
            margin-top: 20px;
            overflow-x: auto; /* Enable horizontal scrolling for tables on small screens */
            background-color: var(--card-background);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .table-container h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        table th, table td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
            white-space: nowrap; /* Prevent text wrapping in table cells */
        }

        table thead {
            background-color: var(--primary-color);
            color: var(--header-text);
        }

        table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table tbody tr:hover {
            background-color: #f1f1f1;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        .card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .card h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        #totalLeads {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--header-bg);
            text-align: center;
            margin-top: 10px;
        }

        .category-list {
            list-style: none;
            padding: 0;
        }

        .category-list li {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-list li:last-child {
            border-bottom: none;
        }

        .category-list span.count {
            font-weight: bold;
            color: var(--primary-color);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        canvas {
            max-width: 100%;
            height: auto;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 1.5em;
            color: var(--primary-color);
            display: none; /* Hidden by default */
        }

        .loading-overlay.active {
            display: flex;
        }

        .error-message {
            color: #D32F2F; /* Red */
            background-color: #FFCDD2;
            border: 1px solid #EF9A9A;
            padding: 10px;
            margin-top: 20px;
            border-radius: var(--border-radius);
            display: none;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        Loading data...
    </div>

    <header>
        <h1>Lead Dashboard - The Rising</h1>
    </header>

    <div class="container">
        <div class="date-picker-container">
            <label for="datePicker">Select Date:</label>
            <input type="text" id="datePicker" placeholder="Select Date">
        </div>

        <div class="table-container">
            <h2>Raw Leads Data for Selected Date (The Rising)</h2>
            <table id="leadsTable">
                <thead>
                    <tr>
                        </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div class="error-message" id="errorMessage">
            An error occurred while fetching data. Please ensure your Google Apps Script Web App is correctly deployed and accessible.
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h2>Total Leads for Selected Date</h2>
                <div id="totalLeads">0</div>
            </div>

            <div class="card">
                <h2>Leads by Interest</h2>
                <ul id="interestList" class="category-list">
                    <li>No data</li>
                </ul>
            </div>

            <div class="card">
                <h2>Leads by Intention</h2>
                <ul id="intentionList" class="category-list">
                    <li>No data</li>
                </ul>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
                <h2>Weekly Leads Progress</h2>
                <div class="chart-container">
                    <canvas id="leadsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ** IMPORTANT: Replace with your deployed Google Apps Script Web App URL **
        const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwmItCcieqlaxFZ_6_CSlKnhA7rcxCL2B_qt9ZHwelTDADbmrYDLyZzqCiIe6uHjc9A/exec'; // e.g., 'https://script.google.com/macros/s/AKfycbz.../exec'

        const totalLeadsElement = document.getElementById('totalLeads');
        const interestListElement = document.getElementById('interestList');
        const intentionListElement = document.getElementById('intentionList');
        const leadsTable = document.getElementById('leadsTable');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const errorMessage = document.getElementById('errorMessage');
        let leadsChart;

        function showLoading() {
            loadingOverlay.classList.add('active');
            errorMessage.style.display = 'none';
        }

        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        function showErrorMessage() {
            errorMessage.style.display = 'block';
        }

        function formatDateForAppsScript(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function resetDashboard() {
            totalLeadsElement.textContent = '0';
            interestListElement.innerHTML = '<li>No data</li>';
            intentionListElement.innerHTML = '<li>No data</li>';
            leadsTable.querySelector('thead tr').innerHTML = '';
            leadsTable.querySelector('tbody').innerHTML = '<tr><td colspan="7">No data available for "The Rising" on this date.</td></tr>'; // Updated message
            if (leadsChart) {
                leadsChart.data.labels = [];
                leadsChart.data.datasets[0].data = [];
                leadsChart.update();
            }
        }

        function updateCategoryList(element, counts) {
            element.innerHTML = '';
            const sortedCategories = Object.entries(counts).sort(([, a], [, b]) => b - a);
            if (sortedCategories.length > 0) {
                sortedCategories.forEach(([category, count]) => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span>${category}</span> <span class="count">${count}</span>`;
                    element.appendChild(listItem);
                });
            } else {
                element.innerHTML = '<li>No data</li>';
            }
        }

        function updateLeadsChart(weeklyLeadsChartData) {
            const chartLabels = weeklyLeadsChartData.labels;
            const chartData = weeklyLeadsChartData.data;

            const style = getComputedStyle(document.body);
            const primaryColor = style.getPropertyValue('--primary-color').trim();

            if (leadsChart) {
                leadsChart.data.labels = chartLabels;
                leadsChart.data.datasets[0].data = chartData;
                leadsChart.update();
            } else {
                const ctx = document.getElementById('leadsChart').getContext('2d');
                leadsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Leads',
                            data: chartData,
                            backgroundColor: primaryColor,
                            borderColor: primaryColor,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Leads'
                                },
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {if (value % 1 === 0) {return value;}}
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date (dd-mm-yyyy)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.raw;
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Updated: Function to populate the raw data table with selected date's data
        function updateLeadsTable(headers, data, selectedDate) {
            const theadRow = leadsTable.querySelector('thead tr');
            const tbody = leadsTable.querySelector('tbody');

            theadRow.innerHTML = '';
            tbody.innerHTML = '';

            // Populate table headers
            if (headers && headers.length > 0) {
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    theadRow.appendChild(th);
                });
            } else {
                for (let i = 0; i < 7; i++) {
                    const th = document.createElement('th');
                    th.textContent = `Column ${String.fromCharCode(65 + i)}`;
                    theadRow.appendChild(th);
                }
            }

            // Populate table body with data for the selected date only
            const filteredData = data.filter(row => {
                // Assuming date is in the first column (index 0) and is in 'dd-mm-yyyy hh:mm:ss' format
                const rowDateString = row[0] ? row[0].split(' ')[0] : ''; // Get 'dd-mm-yyyy' part
                return rowDateString === formatDateForAppsScript(selectedDate);
            });


            if (filteredData && filteredData.length > 0) {
                filteredData.forEach(rowData => {
                    const tr = document.createElement('tr');
                    rowData.forEach(cellData => {
                        const td = document.createElement('td');
                        td.textContent = cellData;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            } else {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = headers.length > 0 ? headers.length : 7;
                td.textContent = `No "The Rising" data found for ${formatDateForAppsScript(selectedDate)}.`;
                tr.appendChild(td);
                tbody.appendChild(tr);
            }
        }


        async function fetchData(selectedDate) {
            showLoading();
            const formattedDate = formatDateForAppsScript(selectedDate);
            // Pass the selected date to Apps Script so it can filter the table data directly
            const url = `${APPS_SCRIPT_WEB_APP_URL}?date=${formattedDate}&_t=${new Date().getTime()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                const data = await response.json();

                if (data.error) {
                    console.error("Apps Script Error:", data.error);
                    showErrorMessage();
                    resetDashboard();
                    return;
                }

                totalLeadsElement.textContent = data.totalLeads;
                updateCategoryList(interestListElement, data.interestCounts);
                updateCategoryList(intentionListElement, data.intentionCounts);
                updateLeadsChart(data.weeklyLeadsChart);
                // Pass the original selectedDate to the table update function for client-side filtering
                updateLeadsTable(data.tableData.headers, data.tableData.rows, selectedDate);


            } catch (error) {
                console.error("Error fetching data:", error);
                showErrorMessage();
                resetDashboard();
            } finally {
                hideLoading();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            flatpickr("#datePicker", {
                dateFormat: "d-m-Y",
                defaultDate: today,
                maxDate: "today",
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0) {
                        fetchData(selectedDates[0]);
                    }
                }
            });

            fetchData(today);
        });
    </script>
</body>
</html>
